---
title: 数据库：说一说InnoDB刷脏页
tags:
  - 总结
  - MySQL
categories:
  - MySQL
#keywords: "hello 1"
cover: https://pic.imgdb.cn/item/65e21e529f345e8d0387b178.webp
toc: True
abbrlink: 6
---

# 为什么SQL语句正常时很快，有时很慢？也就是“抖”一下（本质就是问说一说InnoDB刷脏页）
  # 原因分析
  - 可能是在刷脏页（flush）（脏页即当内存数据页跟磁盘数据页内容不一致的时候，称这个内存页为脏页。）
    - 第一种情况是redo log写满了。这时候系统会停止所有更新操作，把checkpoint往前推进，并且刷脏页，redo log留出空间可以继续写。
    - 第二种情况就是系统内存不足。这时候会要淘汰一些数据页，如果淘汰的是“脏页”，需要先将脏页写入磁盘。
      - InnoDB缓冲池中的内存页的三种状态
        - 还没使用的
        - 使用了的干净页
        - 使用了的脏页
      - 申请数据页
        - 当要读入的数据页没有在内存的时候，就必须到缓冲池中申请一个数据页。这时候得把最久不使用的数据页从内存中淘汰掉。当淘汰的是脏页的时候就得先刷脏页，出现以下两种情况便会影响性能
          - 一个查询要淘汰的脏页个数太多，导致这个查询的响应时间明显变长。
          - 日志写满了，更新全堵住，写性能跌为0。 
    - 第三种情况是MySQL认为系统处于“空闲”状态，会进行刷脏页，但既然都是空闲了，不太可能影响性能
    - 第四种情况是MySQL正常关闭的情况，也会刷脏页。正常关闭了，也不会影响性能。
    # InnoDB刷脏页的控制策略
      - 为什么需要
        - InnoDB需要有控制脏页比例的机制，来尽量避免一次性淘汰的脏页过多或者日志写满影响读写性能。
        - 刷脏页具体机制以及这些策略相关的参数
          - 首先通过设置innodb_io_capacity告诉InnoDB磁盘读写能力，通常设置成磁盘的IOPS，可通过fio工具测试，得到InnoDB最大刷脏页速度。
          - InnoDB通过全力的百分比来刷脏页
            - InnoDB会先根据脏页占整个缓存池的比例以及redo log写盘速度两个因素算出两个值。
              - 参数innodb_maxdirty_pages_pct是脏页的比例上限，默认75%。
              - 第一个值是依据脏页占缓存池的比例算出来的
              - 第二个值是根据redo log中write pos和checkpoint的差值计算出来的
              - 最后按照最大刷脏页速度 * max（f1，f2）%的速度刷脏页





